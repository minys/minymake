#!/bin/bash

export obj="a/main.o b/c/c.o b/d/d.o b/main.o c/c.o d/shared.o e/main.o f/main.o g/main.o main.o"
export test_obj="e/test.o"
export dep="a/main.d b/c/c.d b/d/d.d b/main.d c/c.d d/shared.d e/main.d f/main.d g/main.d main.d"
export test_dep="e/test.d"
export notes="main.gcno a/main.gcno b/main.gcno b/c/c.gcno b/d/d.gcno c/c.gcno d/shared.gcno e/main.gcno f/main.gcno g/main.gcno"
export test_notes="e/test.gcno"
export checksum=".compile.cc.checksum .compile.cxx.checksum .link.cc.checksum .link.cxx.checksum"
export targets="a/program_a a/test_dupl b/program_b c/test_cc d/libshared.so e/program_e f/test_shared g/zlib_test program h/test_sbin"
export programs="program_a test_cc test_dupl program_b program_e test_shared zlib_test program"
export system_programs="test_sbin"
export libraries="libshared.so"
export archives="libshared.a"
export data="data.dat"
export libdata="shared.dat"
export tests="e/test.o e/test_program"
export all_no_tests="${obj} ${dep} ${checksum} ${targets}"
export all="${all_no_tests} ${test_obj} ${test_dep} ${tests}"
export all_coverage="${all} ${notes} ${test_notes}"
export all_static="${all//.so/.a}"

test=$(which test 2>/dev/null)

get_tmpdir ()
{
	if [ -w ${_TMPDIR} ] && [ -d "${_TMPDIR}" ]; then
		rm -rf ${_TMPDIR}/*
		echo ${_TMPDIR}
	else
		error '_TMPDIR does not exist or lacking write access'
	fi
}

get_tmpfile ()
{
	if [ -w ${_TMPFILE} ]; then
		echo > ${_TMPFILE}
		echo ${_TMPFILE}
	else
		error '_TMPFILE does not exist or lacking write access'
	fi
}

test_start ()
{
	CURRENT_TEST=$(basename ${1})
	printf '\n\e[1;34m%s\e[0m %s\n' TEST "$(basename ${1})"
	make clean >/dev/null
}

test_step ()
{
	printf '\n\e[1;34m%s\e[0m %s\n\n' "TEST STEP" "${@}"
}

assert_equal ()
{
	local result=0

	test ${1} -eq ${2} || result=$?
	if [ "${result}" -ne 0 ] && [ -n "${3}" ]; then
		FAILURE="${3}"
	else
		FAILURE="assert_equal failed (${1} not equal to ${2})"
	fi

	return ${result}
}

assert_exist ()
{
	local result=0
	local object=$(readlink -m ${1})

	${test} -e ${object} || result=$?
	[ "${result}" -ne 0 ] &&
		FAILURE="should exist but does not: ${object}"

	return ${result}
}

assert_not_exist ()
{
	local result=0
	local object=$(readlink -m ${1})

	${test} ! -e ${object} || result=$?
	[ "${result}" -ne 0 ] &&
		FAILURE="should not exist but does: ${object}"

	return ${result}
}

assert_newer_than ()
{
	local result=0
	local file_a=$(readlink -m ${1})
	local file_b=$(readlink -m ${2})

	${test} ${file_a} -nt ${file_b} || result=$?
	[ "${result}" -ne 0 ] &&
		FAILURE="${file_a} should be newer than ${file_b}"

	return ${result}
}

assert_older_than ()
{
	local result=0
	local file_a=$(readlink -m ${1})
	local file_b=$(readlink -m ${2})

	${test} ${file_a} -ot ${file_b} || result=$?
	[ "${result}" -ne 0 ] &&
		FAILURE="${file_a} should be newer than ${file_b}"

	return ${result}
}

assert_fail ()
{
	FAILURE="$@"

	return 1
}

assert_clean ()
{
	test_step "Verify that build output was removed"

	for file in ${all}; do
		assert_not_exist ${file} || return 1
	done

	return 0
}

assert_full_build ()
{
	test_step "Verify build output"

	for file in ${all}; do
		assert_exist ${file} || return 1
	done

	return 0
}

assert_full_static_build ()
{
	test_step "Verify static build output"

	for file in ${all_static}; do
		assert_exist ${file} || return 1
	done

	return 0
}

assert_full_build_no_tests ()
{
	test_step "Verify build output"

	for file in ${all_no_tests}; do
		assert_exist ${file} || return 1
	done

	return 0
}

assert_full_build_coverage ()
{
	test_step "Verify build output (including coverage)"

	for file in ${all_coverage}; do
		assert_exist ${file} || return 1
	done

	return 0
}
